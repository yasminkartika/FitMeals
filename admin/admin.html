<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - FitMeals</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body class="bg-gray-100">
    <!-- Loading Screen -->
    <div
      id="loadingScreen"
      class="fixed inset-0 bg-white z-50 flex items-center justify-center"
    >
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mx-auto mb-4"
        ></div>
        <p class="text-gray-600">Memverifikasi autentikasi admin...</p>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4">
          <div class="flex items-center">
            <h1 class="text-2xl font-bold text-gray-900">FitMeals Admin</h1>
          </div>
          <div class="flex items-center space-x-4">
            <span id="adminName" class="text-gray-700"></span>
            <button
              id="logoutBtn"
              class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content with Sidebar -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex gap-6">
      <!-- Sidebar -->
      <aside class="w-64 bg-white rounded-lg shadow p-6 h-fit self-start">
        <nav class="flex flex-col space-y-4">
          <button
            id="sidebarDashboard"
            class="text-left px-4 py-2 rounded hover:bg-gray-100 font-medium text-gray-700"
          >
            Dashboard
          </button>
          <button
            id="sidebarUsers"
            class="text-left px-4 py-2 rounded hover:bg-blue-100 font-medium text-gray-700"
          >
            Manajemen Pengguna
          </button>
          <button
            id="sidebarOrders"
            class="relative text-left px-4 py-2 rounded hover:bg-green-100 font-medium text-gray-700"
          >
            Manajemen Pesanan
            <span
              id="orderNotifBadge"
              class="absolute top-2 right-2 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white bg-red-600 rounded-full"
              >3</span
            >
          </button>
          <button
            id="sidebarMenu"
            class="text-left px-4 py-2 rounded hover:bg-blue-100 font-medium text-gray-700"
          >
            Manajemen Menu
          </button>
          <button
            id="sidebarPaket"
            class="text-left px-4 py-2 rounded hover:bg-blue-100 font-medium text-gray-700"
          >
            Manajemen Paket
          </button>
          <button
            id="sidebarNotif"
            class="text-left px-4 py-2 rounded hover:bg-purple-100 font-medium text-gray-700"
          >
            Notifikasi Promo
          </button>
          <button
            id="sidebarProfile"
            class="text-left px-4 py-2 rounded hover:bg-orange-100 font-medium text-gray-700"
          >
            Profil Admin
          </button>
        </nav>
      </aside>
      <!-- Main Dashboard Content -->
      <main class="flex-1" id="mainContent">
        <!-- Dashboard default content (statistik + data terbaru) -->
        <div id="dashboardContent">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Statistik Pengguna -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Total Pengguna
              </h3>
              <div class="flex items-center">
                <div class="text-3xl font-bold text-blue-600" id="totalUsers">
                  -
                </div>
                <div class="ml-4">
                  <button
                    id="viewUsersBtn"
                    class="text-blue-600 hover:text-blue-800 text-sm font-medium"
                  >
                    Lihat Semua →
                  </button>
                </div>
              </div>
            </div>
            <!-- Statistik Pesanan -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Total Pesanan
              </h3>
              <div class="flex items-center">
                <div class="text-3xl font-bold text-green-600" id="totalOrders">
                  -
                </div>
                <div class="ml-4">
                  <button
                    id="viewOrdersBtn"
                    class="text-green-600 hover:text-green-800 text-sm font-medium"
                  >
                    Lihat Semua →
                  </button>
                </div>
              </div>
            </div>
            <!-- Statistik Pendapatan -->
            <div class="bg-white rounded-lg shadow p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Total Pendapatan
              </h3>
              <div class="flex items-center">
                <div
                  class="text-3xl font-bold text-purple-600"
                  id="totalRevenue"
                >
                  -
                </div>
                <div class="ml-4">
                  <span class="text-sm text-gray-500">IDR</span>
                </div>
              </div>
            </div>
          </div>
          <!-- Tabel Data -->
          <div class="mt-8 bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-semibold text-gray-900">Data Terbaru</h3>
            </div>
            <div class="p-6">
              <div id="dataTable">
                <!-- Data akan dimuat di sini -->
              </div>
            </div>
          </div>
        </div>
        <!-- Konten Manajemen Pengguna -->
        <div id="usersContent" class="hidden">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Manajemen Pengguna</h2>
            <div id="usersTable">Daftar pengguna akan ditampilkan di sini.</div>
          </div>
        </div>
        <!-- Konten Manajemen Pesanan -->
        <div id="ordersContent" class="hidden">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold">Manajemen Pesanan</h2>
              <div class="flex space-x-2">
                <select
                  id="statusFilter"
                  class="border rounded px-3 py-1 text-sm"
                >
                  <option value="">Semua Status</option>
                  <option value="Pending Payment">Pending Payment</option>
                  <option value="Paid">Paid</option>
                  <option value="Processing">Processing</option>
                  <option value="Diproses">Diproses</option>
                  <option value="Dikirim">Dikirim</option>
                  <option value="Selesai">Selesai</option>
                  <option value="Dibatalkan">Dibatalkan</option>
                </select>
                <button
                  onclick="loadOrders()"
                  class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700"
                >
                  <i class="fas fa-sync-alt mr-1"></i>Refresh
                </button>
              </div>
            </div>
            <div id="ordersTable" class="overflow-x-auto">
              <div class="text-center text-gray-500">
                Memuat data pesanan...
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Update Status Pesanan -->
        <div
          id="orderStatusModal"
          class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
        >
          <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold">Update Status Pesanan</h3>
              <button
                onclick="closeOrderStatusModal()"
                class="text-gray-500 hover:text-gray-700 text-2xl"
              >
                &times;
              </button>
            </div>

            <form id="orderStatusForm">
              <input type="hidden" id="orderIdInput" />

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Status Baru</label
                >
                <select
                  id="newStatusSelect"
                  class="w-full border rounded px-3 py-2"
                  required
                >
                  <option value="">Pilih Status</option>
                  <option value="Pending Payment">Pending Payment</option>
                  <option value="Paid">Paid</option>
                  <option value="Processing">Processing</option>
                  <option value="Diproses">Diproses</option>
                  <option value="Dikirim">Dikirim</option>
                  <option value="Selesai">Selesai</option>
                  <option value="Dibatalkan">Dibatalkan</option>
                </select>
              </div>

              <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Catatan Admin (Opsional)</label
                >
                <textarea
                  id="adminNotesInput"
                  class="w-full border rounded px-3 py-2"
                  rows="3"
                  placeholder="Tambahkan catatan untuk pesanan ini..."
                ></textarea>
              </div>

              <div class="flex justify-end space-x-2">
                <button
                  type="button"
                  onclick="closeOrderStatusModal()"
                  class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                >
                  Batal
                </button>
                <button
                  type="submit"
                  class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                >
                  Update Status
                </button>
              </div>
            </form>
          </div>
        </div>
        <!-- Konten Manajemen Menu -->
        <div id="menuContent" class="hidden">
          <div class="bg-white rounded-lg shadow p-6">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold">Manajemen Menu</h2>
              <button
                onclick="showMenuForm()"
                class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-200"
              >
                + Tambah Menu
              </button>
            </div>

            <!-- Form Menu -->
            <div id="menuForm" class="hidden mb-6 bg-gray-50 p-4 rounded-lg">
              <h3 class="text-lg font-semibold mb-4" id="menuFormTitle">
                Tambah Menu Baru
              </h3>
              <form id="menuFormElement" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Upload Gambar Menu *</label
                    >
                    <input
                      type="file"
                      id="menuGambarFile"
                      class="w-full border rounded px-3 py-2"
                      accept="image/*"
                    />
                    <img
                      id="menuGambarPreview"
                      src=""
                      alt="Preview Gambar"
                      class="mt-2 w-32 h-32 object-cover rounded hidden"
                    />
                    <input type="hidden" id="menuGambar" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Nama Menu *</label
                    >
                    <input
                      type="text"
                      id="menuNama"
                      class="w-full border rounded px-3 py-2"
                      required
                    />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >Deskripsi *</label
                  >
                  <textarea
                    id="menuDeskripsi"
                    class="w-full border rounded px-3 py-2"
                    rows="2"
                    required
                  ></textarea>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Harga (Rp) *</label
                    >
                    <input
                      type="number"
                      id="menuHarga"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Kategori *</label
                    >
                    <select
                      id="menuKategori"
                      class="w-full border rounded px-3 py-2"
                      required
                    >
                      <option value="sarapan">Sarapan</option>
                      <option value="makan_siang">Makan Siang</option>
                      <option value="makan_malam">Makan Malam</option>
                      <option value="snack">Snack</option>
                      <option value="minuman">Minuman</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Status *</label
                    >
                    <select
                      id="menuStatus"
                      class="w-full border rounded px-3 py-2"
                      required
                    >
                      <option value="aktif">Aktif</option>
                      <option value="nonaktif">Nonaktif</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Minggu *</label
                    >
                    <input
                      type="number"
                      id="menuMinggu"
                      class="w-full border rounded px-3 py-2"
                      min="1"
                      value="1"
                      required
                    />
                  </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Kalori (kcal) *</label
                    >
                    <input
                      type="number"
                      id="menuKalori"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Fat (g)</label
                    >
                    <input
                      type="number"
                      id="menuLemak"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Saturated Fat (g)</label
                    >
                    <input
                      type="number"
                      id="menuSaturatedFat"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Cholesterol (mg)</label
                    >
                    <input
                      type="number"
                      id="menuCholesterol"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Protein (g)</label
                    >
                    <input
                      type="number"
                      id="menuProtein"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Carbohydrates (g)</label
                    >
                    <input
                      type="number"
                      id="menuKarbohidrat"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Fiber (g)</label
                    >
                    <input
                      type="number"
                      id="menuSerat"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Gula (g)</label
                    >
                    <input
                      type="number"
                      id="menuGula"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1"
                      >Sodium (mg)</label
                    >
                    <input
                      type="number"
                      id="menuSodium"
                      class="w-full border rounded px-3 py-2"
                      min="0"
                      value="0"
                    />
                  </div>
                </div>

                <div class="flex gap-2">
                  <button
                    type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                  >
                    Simpan Menu
                  </button>
                  <button
                    type="button"
                    onclick="hideMenuForm()"
                    class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600"
                  >
                    Batal
                  </button>
                </div>
              </form>
            </div>

            <!-- Tabel Menu -->
            <div id="menuTable" class="overflow-x-auto">
              <div class="text-center text-gray-500">Memuat data menu...</div>
            </div>
          </div>
        </div>
        <!-- Konten Manajemen Paket -->
        <div id="paketContent" class="hidden">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Manajemen Paket</h2>
            <button onclick="showPaketForm()">Tambah Paket</button>
            <div id="paketTable"></div>
            <div id="paketForm" style="display: none">
              <!-- Form tambah/edit paket -->
              <input id="paketNama" placeholder="Nama Paket" />
              <input id="paketDeskripsi" placeholder="Deskripsi" />
              <input id="paketHarga" type="number" placeholder="Harga" />
              <input id="paketMenu" placeholder="ID Menu (pisahkan koma)" />
              <button onclick="submitPaket()">Simpan</button>
              <button onclick="hidePaketForm()">Batal</button>
            </div>
          </div>
        </div>
        <!-- Konten Notifikasi Promo -->
        <div id="notifContent" class="hidden">
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold mb-4">Kirim Notifikasi Promo</h2>
            <form id="promoForm" class="space-y-4">
              <div>
                <label class="block text-gray-700 mb-1" for="promoTitle"
                  >Judul Promo</label
                >
                <input
                  type="text"
                  id="promoTitle"
                  class="w-full border rounded px-3 py-2"
                  required
                />
              </div>
              <div>
                <label class="block text-gray-700 mb-1" for="promoMessage"
                  >Pesan Promo</label
                >
                <textarea
                  id="promoMessage"
                  class="w-full border rounded px-3 py-2"
                  rows="4"
                  required
                ></textarea>
              </div>
              <button
                type="submit"
                class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
              >
                Kirim Promo
              </button>
            </form>
            <div id="promoStatus" class="mt-4 text-sm"></div>
          </div>
        </div>
      </main>
    </div>

    <!-- 🛡️ Proteksi Admin -->
    <script>
      // Fungsi untuk cek autentikasi admin
      async function checkAdminAuth() {
        const admin = JSON.parse(localStorage.getItem("admin"));
        const adminToken = localStorage.getItem("adminToken");

        console.log("🔍 Checking admin auth...");
        console.log("Admin data:", admin);
        console.log("Admin token:", adminToken);

        // Cek apakah ada data admin dan token
        if (!admin || !adminToken) {
          console.log("❌ No admin data or token found");
          redirectToLogin();
          return false;
        }

        // Cek apakah role adalah admin
        if (admin.role !== "admin") {
          console.log("❌ User is not admin");
          redirectToLogin();
          return false;
        }

        // Cek format token
        if (!adminToken.startsWith('admin_')) {
          console.log("❌ Invalid token format");
          redirectToLogin();
          return false;
        }

        // Verifikasi token dengan server
        try {
          console.log("📡 Verifying token with server...");
          const response = await fetch("/api/admin/verify-token", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${adminToken}`,
            },
          });

          console.log("📥 Response status:", response.status);

          if (!response.ok) {
            console.log("❌ Token verification failed");
            const errorData = await response.json();
            console.log("Error details:", errorData);
            return false;
          }

          const data = await response.json();
          console.log("📄 Response data:", data);

          if (!data.valid) {
            console.log("❌ Token is invalid");
            return false;
          }

          console.log("✅ Admin authentication successful");
          return true;
        } catch (error) {
          console.error("❌ Error verifying token:", error);
          return false;
        }
      }

      // Fungsi untuk redirect ke login
      function redirectToLogin() {
        // Clear localStorage
        localStorage.removeItem("admin");
        localStorage.removeItem("adminToken");

        // Tampilkan pesan error
        const loadingScreen = document.getElementById("loadingScreen");
        loadingScreen.innerHTML = `
          <div class="text-center">
            <div class="text-red-600 text-6xl mb-4">🚫</div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Akses Ditolak</h2>
            <p class="text-gray-600 mb-4">Anda harus login sebagai admin untuk mengakses halaman ini.</p>
            <button onclick="window.location.href='login.html'" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
              Login Admin
            </button>
          </div>
        `;

        // Redirect otomatis setelah 3 detik
        setTimeout(() => {
          window.location.href = "login.html";
        }, 3000);
      }

      // Cek autentikasi saat halaman dimuat
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("🚀 Admin page loaded, checking authentication...");
        
        const isAuthenticated = await checkAdminAuth();

        if (!isAuthenticated) {
          console.log("❌ Authentication failed, redirecting to login...");
          return; // Halaman akan di-redirect
        }

        console.log("✅ Authentication successful, initializing dashboard...");

        // Jika autentikasi berhasil, inisialisasi dashboard
        const admin = JSON.parse(localStorage.getItem("admin"));
        document.getElementById(
          "adminName"
        ).textContent = `Admin: ${admin.namaLengkap}`;

        // Sembunyikan loading screen
        document.getElementById("loadingScreen").style.display = "none";

        // Load data dashboard
        loadDashboardData();
      });

      // Cek autentikasi setiap 5 menit
      setInterval(async () => {
        await checkAdminAuth();
      }, 5 * 60 * 1000);

      // Proteksi tambahan - cek jika localStorage dimanipulasi
      window.addEventListener("storage", function (e) {
        if (e.key === "admin" || e.key === "adminToken") {
          checkAdminAuth();
        }
      });

      // Proteksi dari developer tools
      document.addEventListener("keydown", function (e) {
        // Disable F12, Ctrl+Shift+I, Ctrl+U, Ctrl+Shift+C
        if (
          e.key === "F12" ||
          (e.ctrlKey && e.shiftKey && e.key === "I") ||
          (e.ctrlKey && e.key === "u") ||
          (e.ctrlKey && e.shiftKey && e.key === "C")
        ) {
          e.preventDefault();
          return false;
        }
      });

      // Disable right click
      document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
        return false;
      });

      // Event listener untuk logout
      document
        .getElementById("logoutBtn")
        .addEventListener("click", async () => {
          try {
            const adminToken = localStorage.getItem("adminToken");
            const response = await fetch("/api/admin/logout", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${adminToken}`,
                "Content-Type": "application/json",
              },
            });

            // Clear localStorage
            localStorage.removeItem("admin");
            localStorage.removeItem("adminToken");

            // Redirect ke login
            window.location.href = "login.html";
          } catch (error) {
            console.error("Logout error:", error);
            // Tetap logout meski ada error
            localStorage.removeItem("admin");
            localStorage.removeItem("adminToken");
            window.location.href = "login.html";
          }
        });

      // Event listener untuk view users
      document.getElementById("viewUsersBtn").addEventListener("click", () => {
        // Pindah ke tab Manajemen Pengguna dan load data user
        dashboardContent.classList.add("hidden");
        usersContent.classList.remove("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.add("hidden");
        loadUsers();
      });

      // Event listener untuk view orders
      document.getElementById("viewOrdersBtn").addEventListener("click", () => {
        // Implementasi untuk melihat semua pesanan
        alert("Fitur melihat semua pesanan akan diimplementasikan");
      });

      // Fungsi untuk load data dashboard
      async function loadDashboardData() {
        try {
          const adminToken = localStorage.getItem("adminToken");

          // Load total users
          const usersResponse = await fetch("/api/admin/getUsers", {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });

          if (usersResponse.ok) {
            const usersData = await usersResponse.json();
            document.getElementById("totalUsers").textContent =
              usersData.users.length;
          }

          // Load total orders
          const ordersResponse = await fetch("/api/admin/getOrders", {
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
          });

          if (ordersResponse.ok) {
            const ordersData = await ordersResponse.json();
            document.getElementById("totalOrders").textContent =
              ordersData.orders.length;

            // Hitung total pendapatan
            const totalRevenue = ordersData.orders.reduce((sum, order) => {
              return sum + (order.totalHarga || 0);
            }, 0);

            document.getElementById("totalRevenue").textContent =
              new Intl.NumberFormat("id-ID").format(totalRevenue);
          }
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          // Tampilkan data dummy jika API belum tersedia
          document.getElementById("totalUsers").textContent = "0";
          document.getElementById("totalOrders").textContent = "0";
          document.getElementById("totalRevenue").textContent = "0";
        }
      }

      // Sidebar navigation logic
      const dashboardContent = document.getElementById("dashboardContent");
      const usersContent = document.getElementById("usersContent");
      const ordersContent = document.getElementById("ordersContent");
      const notifContent = document.getElementById("notifContent");

      document
        .getElementById("sidebarDashboard")
        .addEventListener("click", () => {
          dashboardContent.classList.remove("hidden");
          usersContent.classList.add("hidden");
          ordersContent.classList.add("hidden");
          notifContent.classList.add("hidden");
        });
      document.getElementById("sidebarUsers").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.remove("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.add("hidden");
        loadUsers();
      });
      document.getElementById("sidebarOrders").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.add("hidden");
        ordersContent.classList.remove("hidden");
        notifContent.classList.add("hidden");
        menuContent.classList.add("hidden");
        paketContent.classList.add("hidden");
        loadOrders(); // Load orders data
      });
      document.getElementById("sidebarNotif").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.add("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.remove("hidden");
      });

      // Promo form handler (dummy, bisa dihubungkan ke backend nanti)
      document
        .getElementById("promoForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const title = document.getElementById("promoTitle").value;
          const message = document.getElementById("promoMessage").value;
          // Simulasi kirim promo
          document.getElementById(
            "promoStatus"
          ).textContent = `Promo "${title}" berhasil dikirim ke pelanggan!`;
          this.reset();
        });

      const menuContent = document.getElementById("menuContent");
      const paketContent = document.getElementById("paketContent");
      // ...tambahkan pada logic sidebar...
      document.getElementById("sidebarMenu").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.add("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.add("hidden");
        menuContent.classList.remove("hidden");
        paketContent.classList.add("hidden");
      });
      document.getElementById("sidebarPaket").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.add("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.add("hidden");
        menuContent.classList.add("hidden");
        paketContent.classList.remove("hidden");
      });

      // MENU
      async function loadMenu() {
        const menuTable = document.getElementById("menuTable");
        menuTable.innerHTML = "Memuat data...";
        try {
          const adminToken = localStorage.getItem("adminToken");
          const res = await fetch("/api/admin/menu", {
            headers: { Authorization: `Bearer ${adminToken}` },
          });
          if (!res.ok) throw new Error("Gagal mengambil data menu");
          const data = await res.json();

          if (!data.menus || data.menus.length === 0) {
            menuTable.innerHTML =
              '<div class="text-gray-500 text-center">Belum ada menu terdaftar.</div>';
            return;
          }

          // Urutkan menu berdasarkan tanggal pembuatan (terlama dulu)
          const sortedMenus = data.menus.sort((a, b) => {
            const dateA = new Date(a.createdAt || a._id);
            const dateB = new Date(b.createdAt || b._id);
            return dateA - dateB; // Ascending order (oldest first)
          });

          // Render tabel menu
          let html = `<div class="overflow-x-auto">
            <table class="min-w-full border text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-3 py-2">No</th>
                  <th class="border px-3 py-2">Gambar</th>
                  <th class="border px-3 py-2">Nama Menu</th>
                  <th class="border px-3 py-2">Kategori</th>
                  <th class="border px-3 py-2">Harga</th>
                  <th class="border px-3 py-2">Minggu</th>
                  <th class="border px-3 py-2">Tanggal</th>
                  <th class="border px-3 py-2">Status</th>
                  <th class="border px-3 py-2">Aksi</th>
                </tr>
              </thead>
              <tbody>`;

          sortedMenus.forEach((menu, idx) => {
            // Format status badge
            let statusBadge = "";
            switch (menu.status) {
              case "aktif":
                statusBadge =
                  '<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">Aktif</span>';
                break;
              case "nonaktif":
                statusBadge =
                  '<span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">Nonaktif</span>';
                break;
              default:
                statusBadge =
                  '<span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">Unknown</span>';
            }

            html += `<tr>
              <td class="border px-3 py-2 text-center">${idx + 1}</td>
              <td class="border px-3 py-2 text-center">
                <img src="${menu.gambar}" alt="${
              menu.nama
            }" class="w-16 h-16 object-cover rounded mx-auto">
              </td>
              <td class="border px-3 py-2">
                <div class="font-medium">${menu.nama}</div>
                <div class="text-xs text-gray-500">${menu.deskripsi.substring(
                  0,
                  50
                )}...</div>
              </td>
              <td class="border px-3 py-2 text-center">
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${menu.kategori.replace(
                  "_",
                  " "
                )}</span>
              </td>
              <td class="border px-3 py-2 text-center">Rp ${new Intl.NumberFormat(
                "id-ID"
              ).format(menu.harga)}</td>
              <td class="border px-3 py-2 text-center">
                <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs">Minggu ${
                  menu.minggu || 1
                }</span>
              </td>
              <td class="border px-3 py-2 text-center text-xs">${statusBadge}</td>
              <td class="border px-3 py-2 text-center">
                <button onclick="editMenu('${
                  menu._id
                }')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1">Edit</button>
                <button onclick="deleteMenu('${
                  menu._id
                }')" class="bg-red-600 text-white px-2 py-1 rounded text-xs">Hapus</button>
              </td>
            </tr>`;
          });

          html += "</tbody></table></div>";
          menuTable.innerHTML = html;
        } catch (error) {
          menuTable.innerHTML = `<div class="text-red-600">Gagal memuat data menu: ${error.message}</div>`;
        }
      }

      async function submitMenu() {
        const form = document.getElementById("menuFormElement");
        const fileInput = document.getElementById("menuGambarFile");
        const isEdit = form.dataset.menuId;
        let gambarPath = "";
        const adminToken = localStorage.getItem("adminToken");

        // 1. Upload gambar jika ada file baru
        if (fileInput.files && fileInput.files[0]) {
          const formData = new FormData();
          formData.append("photo", fileInput.files[0]);
          try {
            const uploadRes = await fetch("/api/admin/uploadPhoto/menu", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${adminToken}`,
              },
              body: formData,
            });
            const uploadData = await uploadRes.json();
            if (uploadRes.ok && uploadData.imageUrl) {
              gambarPath = uploadData.imageUrl;
            } else {
              alert(
                "Gagal upload gambar: " +
                  (uploadData.message || "Unknown error")
              );
              return;
            }
          } catch (err) {
            alert("Gagal upload gambar: " + err.message);
            return;
          }
        } else if (isEdit) {
          // Jika edit dan tidak ada file baru, gunakan gambar yang sudah ada
          gambarPath = document.getElementById("menuGambar").value;
        } else {
          alert("Pilih file gambar terlebih dahulu!");
          return;
        }

        // 2. Siapkan data menu
        const menuData = {
          nama: document.getElementById("menuNama").value,
          deskripsi: document.getElementById("menuDeskripsi").value,
          gambar: gambarPath,
          harga: Number(document.getElementById("menuHarga").value) || 0,
          kategori: document.getElementById("menuKategori").value,
          status: document.getElementById("menuStatus").value,
          urutan: 0, // default
          minggu: Number(document.getElementById("menuMinggu").value) || 1,
          nutrisi: {
            kalori: Number(document.getElementById("menuKalori").value) || 0,
            lemak: Number(document.getElementById("menuLemak").value) || 0,
            saturatedFat:
              Number(document.getElementById("menuSaturatedFat").value) || 0,
            cholesterol:
              Number(document.getElementById("menuCholesterol").value) || 0,
            protein: Number(document.getElementById("menuProtein").value) || 0,
            karbohidrat:
              Number(document.getElementById("menuKarbohidrat").value) || 0,
            serat: Number(document.getElementById("menuSerat").value) || 0,
            gula: Number(document.getElementById("menuGula").value) || 0,
            sodium: Number(document.getElementById("menuSodium").value) || 0,
          },
        };

        try {
          const method = isEdit ? "PUT" : "POST";
          const url = isEdit
            ? `/api/admin/menu?id=${form.dataset.menuId}`
            : "/api/admin/menu";

          const response = await fetch(url, {
            method: method,
            headers: {
              Authorization: `Bearer ${adminToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(menuData),
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message);
            hideMenuForm();
            loadMenu();
          } else {
            alert(`Error: ${result.message}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }

      async function editMenu(menuId) {
        try {
          const adminToken = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/menu?id=${menuId}`, {
            headers: { Authorization: `Bearer ${adminToken}` },
          });

          if (!response.ok) throw new Error("Gagal mengambil data menu");
          const data = await response.json();
          const menu = data.menu;

          // Validasi menu data
          if (!menu) {
            throw new Error("Data menu tidak ditemukan");
          }

          // Isi form dengan data menu
          document.getElementById("menuNama").value = menu.nama || "";
          document.getElementById("menuDeskripsi").value = menu.deskripsi || "";
          document.getElementById("menuHarga").value = menu.harga || 0;
          document.getElementById("menuGambar").value = menu.gambar || "";
          document.getElementById("menuKategori").value = menu.kategori || "makan_siang";
          document.getElementById("menuStatus").value = menu.status || "aktif";
          document.getElementById("menuMinggu").value = menu.minggu || 1;

          // Isi data nutrisi
          document.getElementById("menuKalori").value =
            menu.nutrisi?.kalori || 0;
          document.getElementById("menuProtein").value =
            menu.nutrisi?.protein || 0;
          document.getElementById("menuKarbohidrat").value =
            menu.nutrisi?.karbohidrat || 0;
          document.getElementById("menuLemak").value = menu.nutrisi?.lemak || 0;
          document.getElementById("menuSerat").value = menu.nutrisi?.serat || 0;
          document.getElementById("menuGula").value = menu.nutrisi?.gula || 0;
          document.getElementById("menuSaturatedFat").value =
            menu.nutrisi?.saturatedFat || 0;
          document.getElementById("menuCholesterol").value =
            menu.nutrisi?.cholesterol || 0;
          document.getElementById("menuSodium").value =
            menu.nutrisi?.sodium || 0;

          // Tampilkan preview gambar yang sudah ada
          const previewImg = document.getElementById("menuGambarPreview");
          if (menu.gambar) {
            previewImg.src = menu.gambar;
            previewImg.classList.remove("hidden");
          }

          // Set menu ID untuk update
          document.getElementById("menuFormElement").dataset.menuId = menuId;
          document.getElementById("menuFormTitle").textContent = "Edit Menu";

          showMenuForm();
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }

      async function deleteMenu(menuId) {
        if (!confirm("Apakah Anda yakin ingin menghapus menu ini?")) return;

        try {
          const adminToken = localStorage.getItem("adminToken");
          const response = await fetch(`/api/admin/menu?id=${menuId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${adminToken}` },
          });

          const result = await response.json();

          if (response.ok) {
            alert(result.message);
            loadMenu();
          } else {
            alert(`Error: ${result.message}`);
          }
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }

      function showMenuForm() {
        document.getElementById("menuForm").classList.remove("hidden");
      }

      function hideMenuForm() {
        document.getElementById("menuForm").classList.add("hidden");
        document.getElementById("menuFormElement").reset();
        document.getElementById("menuFormElement").dataset.menuId = "";
        document.getElementById("menuFormTitle").textContent =
          "Tambah Menu Baru";
        document.getElementById("menuGambarPreview").classList.add("hidden");
        document.getElementById("menuGambarPreview").src = "";
      }

      // Event listener untuk form menu
      document
        .getElementById("menuFormElement")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          submitMenu();
        });

      // Event listener untuk preview gambar
      document
        .getElementById("menuGambarFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          const preview = document.getElementById("menuGambarPreview");

          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              preview.src = e.target.result;
              preview.classList.remove("hidden");
            };
            reader.readAsDataURL(file);
          } else {
            preview.classList.add("hidden");
          }
        });

      // Load menu saat tab dibuka
      document.getElementById("sidebarMenu").addEventListener("click", () => {
        dashboardContent.classList.add("hidden");
        usersContent.classList.add("hidden");
        ordersContent.classList.add("hidden");
        notifContent.classList.add("hidden");
        menuContent.classList.remove("hidden");
        paketContent.classList.add("hidden");
        loadMenu(); // Load menu data
      });

      // PAKET
      async function loadPaket() {
        const adminToken = localStorage.getItem("adminToken");
        const res = await fetch("/api/admin/paket", {
          headers: { Authorization: `Bearer ${adminToken}` },
        });
        const data = await res.json();
        // Render data.paket ke #paketTable
      }
      async function submitPaket() {
        // Ambil data dari input, POST/PUT ke /api/admin/paket
        // Setelah sukses, panggil loadPaket()
      }
      function showPaketForm() {
        document.getElementById("paketForm").style.display = "block";
      }
      function hidePaketForm() {
        document.getElementById("paketForm").style.display = "none";
      }

      // Fungsi untuk load dan render data user ke tabel
      async function loadUsers() {
        const usersTable = document.getElementById("usersTable");
        usersTable.innerHTML = "Memuat data...";
        try {
          const adminToken = localStorage.getItem("adminToken");
          const response = await fetch("/api/admin/getUsers", {
            headers: { Authorization: `Bearer ${adminToken}` },
          });
          if (!response.ok) throw new Error("Gagal mengambil data user");
          const data = await response.json();
          if (!data.users || data.users.length === 0) {
            usersTable.innerHTML =
              '<div class="text-gray-500">Belum ada pengguna terdaftar.</div>';
            return;
          }

          // Pisahkan admin dan user
          const admins = data.users.filter((user) => user.role === "admin");
          const users = data.users.filter((user) => user.role === "user");

          let html = "";

          // Tabel Admin
          if (admins.length > 0) {
            html += `<div class="mb-8">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Admin (${admins.length})</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full border text-sm">
                  <thead class="bg-red-100">
                    <tr>
                      <th class="border px-3 py-2">No</th>
                      <th class="border px-3 py-2">Nama Lengkap</th>
                      <th class="border px-3 py-2">Email</th>
                      <th class="border px-3 py-2">Username</th>
                      <th class="border px-3 py-2">Nomor HP</th>
                      <th class="border px-3 py-2">Role</th>
                      <th class="border px-3 py-2">Tanggal Daftar</th>
                    </tr>
                  </thead>
                  <tbody>`;
            admins.forEach((admin, idx) => {
              html += `<tr class="bg-red-50">
                <td class="border px-3 py-2 text-center">${idx + 1}</td>
                <td class="border px-3 py-2 font-medium">${
                  admin.namaLengkap || "-"
                }</td>
                <td class="border px-3 py-2">${admin.email || "-"}</td>
                <td class="border px-3 py-2">${admin.username || "-"}</td>
                <td class="border px-3 py-2">${admin.nomorHP || "-"}</td>
                <td class="border px-3 py-2 text-center">
                  <span class="bg-red-600 text-white px-2 py-1 rounded text-xs">${
                    admin.role || "-"
                  }</span>
                </td>
                <td class="border px-3 py-2 text-center">${
                  admin.createdAt
                    ? new Date(admin.createdAt).toLocaleDateString("id-ID")
                    : "-"
                }</td>
              </tr>`;
            });
            html += "</tbody></table></div></div>";
          }

          // Tabel User/Pelanggan
          if (users.length > 0) {
            html += `<div>
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Pelanggan (${users.length})</h3>
              <div class="overflow-x-auto">
                <table class="min-w-full border text-sm">
                  <thead class="bg-blue-100">
                    <tr>
                      <th class="border px-3 py-2">No</th>
                      <th class="border px-3 py-2">Nama Lengkap</th>
                      <th class="border px-3 py-2">Email</th>
                      <th class="border px-3 py-2">Username</th>
                      <th class="border px-3 py-2">Nomor HP</th>
                      <th class="border px-3 py-2">Role</th>
                      <th class="border px-3 py-2">Tanggal Daftar</th>
                    </tr>
                  </thead>
                  <tbody>`;
            users.forEach((user, idx) => {
              html += `<tr class="bg-blue-50">
                <td class="border px-3 py-2 text-center">${idx + 1}</td>
                <td class="border px-3 py-2">${user.namaLengkap || "-"}</td>
                <td class="border px-3 py-2">${user.email || "-"}</td>
                <td class="border px-3 py-2">${user.username || "-"}</td>
                <td class="border px-3 py-2">${user.nomorHP || "-"}</td>
                <td class="border px-3 py-2 text-center">
                  <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">${
                    user.role || "-"
                  }</span>
                </td>
                <td class="border px-3 py-2 text-center">${
                  user.createdAt
                    ? new Date(user.createdAt).toLocaleDateString("id-ID")
                    : "-"
                }</td>
              </tr>`;
            });
            html += "</tbody></table></div></div>";
          }

          // Jika tidak ada data sama sekali
          if (admins.length === 0 && users.length === 0) {
            html =
              '<div class="text-gray-500">Belum ada pengguna terdaftar.</div>';
          }

          usersTable.innerHTML = html;
        } catch (err) {
          usersTable.innerHTML = `<div class="text-red-600">Gagal memuat data pengguna: ${err.message}</div>`;
        }
      }

      // FUNGSI MANAJEMEN PESANAN
      async function loadOrders() {
        const ordersTable = document.getElementById("ordersTable");
        ordersTable.innerHTML =
          '<div class="text-center text-gray-500">Memuat data pesanan...</div>';

        try {
          const adminToken = localStorage.getItem("adminToken");
          const response = await fetch("/api/admin/getOrders", {
            headers: { Authorization: `Bearer ${adminToken}` },
          });

          if (!response.ok) throw new Error("Gagal mengambil data pesanan");
          const data = await response.json();

          if (!data.orders || data.orders.length === 0) {
            ordersTable.innerHTML =
              '<div class="text-gray-500 text-center">Belum ada pesanan terdaftar.</div>';
            return;
          }

          // Filter berdasarkan status jika ada
          const statusFilter = document.getElementById("statusFilter").value;
          let filteredOrders = data.orders;
          if (statusFilter) {
            filteredOrders = data.orders.filter(
              (order) => order.status === statusFilter
            );
          }

          // Urutkan berdasarkan tanggal terbaru
          filteredOrders.sort(
            (a, b) => new Date(b.orderDate) - new Date(a.orderDate)
          );

          let html = `<div class="overflow-x-auto">
            <table class="min-w-full border text-sm">
              <thead class="bg-gray-100">
                <tr>
                  <th class="border px-3 py-2">No</th>
                  <th class="border px-3 py-2">ID Pesanan</th>
                  <th class="border px-3 py-2">Pelanggan</th>
                  <th class="border px-3 py-2">Paket</th>
                  <th class="border px-3 py-2">Total</th>
                  <th class="border px-3 py-2">Tanggal</th>
                  <th class="border px-3 py-2">Status</th>
                  <th class="border px-3 py-2">Aksi</th>
                </tr>
              </thead>
              <tbody>`;

          filteredOrders.forEach((order, idx) => {
            const orderDate = new Date(order.orderDate).toLocaleDateString(
              "id-ID"
            );
            const packageNames = order.packages
              .map((pkg) => pkg.name)
              .join(", ");
            const customerName = order.userId?.namaLengkap || "N/A";
            const customerEmail = order.userId?.email || "N/A";

            // Status badge dengan warna
            let statusBadge = "";
            switch (order.status) {
              case "Pending Payment":
                statusBadge =
                  '<span class="bg-orange-600 text-black px-2 py-1 rounded text-xs">Pending Payment</span>';
                break;
              case "Paid":
                statusBadge =
                  '<span class="bg-blue-600 text-black px-2 py-1 rounded text-xs">Paid</span>';
                break;
              case "Processing":
                statusBadge =
                  '<span class="bg-yellow-600 text-black px-2 py-1 rounded text-xs">Processing</span>';
                break;
              case "Diproses":
                statusBadge =
                  '<span class="bg-purple-600 text-black px-2 py-1 rounded text-xs">Diproses</span>';
                break;
              case "Dikirim":
                statusBadge =
                  '<span class="bg-indigo-600 text-black px-2 py-1 rounded text-xs">Dikirim</span>';
                break;
              case "Selesai":
                statusBadge =
                  '<span class="bg-green-600 text-black px-2 py-1 rounded text-xs">Selesai</span>';
                break;
              case "Dibatalkan":
                statusBadge =
                  '<span class="bg-red-600 text-black px-2 py-1 rounded text-xs">Dibatalkan</span>';
                break;
              default:
                statusBadge =
                  '<span class="bg-gray-600 text-black px-2 py-1 rounded text-xs">Unknown</span>';
            }

            html += `<tr class="hover:bg-gray-50">
              <td class="border px-3 py-2 text-center">${idx + 1}</td>
              <td class="border px-3 py-2 font-mono text-xs">${order._id}</td>
              <td class="border px-3 py-2">
                <div class="font-medium">${customerName}</div>
                <div class="text-xs text-gray-500">${customerEmail}</div>
              </td>
              <td class="border px-3 py-2">
                <div class="text-sm">${packageNames}</div>
              </td>
              <td class="border px-3 py-2 text-right font-medium">
                Rp ${new Intl.NumberFormat("id-ID").format(
                  order.totalAmount || 0
                )}
              </td>
              <td class="border px-3 py-2 text-center text-xs">${orderDate}</td>
              <td class="border px-3 py-2 text-center">${statusBadge}</td>
              <td class="border px-3 py-2 text-center">
                <button onclick="viewOrderDetail('${
                  order._id
                }')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs mr-1 hover:bg-blue-700">
                  Detail
                </button>
                <button onclick="openOrderStatusModal('${order._id}', '${
              order.status
            }')" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                  Update
                </button>
              </td>
            </tr>`;
          });

          html += "</tbody></table></div>";
          ordersTable.innerHTML = html;
        } catch (error) {
          ordersTable.innerHTML = `<div class="text-red-600">Gagal memuat data pesanan: ${error.message}</div>`;
        }
      }

      // Fungsi untuk melihat detail pesanan
      function viewOrderDetail(orderId) {
        // Implementasi untuk melihat detail pesanan
        alert(`Detail pesanan ${orderId} akan ditampilkan di sini.`);
      }

      // Fungsi untuk membuka modal update status
      function openOrderStatusModal(orderId, currentStatus) {
        document.getElementById("orderIdInput").value = orderId;
        document.getElementById("newStatusSelect").value = currentStatus;
        document.getElementById("adminNotesInput").value = "";
        document.getElementById("orderStatusModal").classList.remove("hidden");
      }

      // Fungsi untuk menutup modal update status
      function closeOrderStatusModal() {
        document.getElementById("orderStatusModal").classList.add("hidden");
        document.getElementById("orderStatusForm").reset();
      }

      // Event listener untuk form update status
      document
        .getElementById("orderStatusForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const orderId = document.getElementById("orderIdInput").value;
          const newStatus = document.getElementById("newStatusSelect").value;
          const adminNotes = document.getElementById("adminNotesInput").value;

          if (!newStatus) {
            alert("Pilih status baru terlebih dahulu!");
            return;
          }

          try {
            const adminToken = localStorage.getItem("adminToken");
            const response = await fetch(
              `/api/admin/orders/${orderId}/status`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${adminToken}`,
                },
                body: JSON.stringify({
                  status: newStatus,
                  notes: adminNotes,
                }),
              }
            );

            const result = await response.json();

            if (response.ok) {
              alert("Status pesanan berhasil diupdate!");
              closeOrderStatusModal();
              loadOrders(); // Refresh tabel
            } else {
              alert(`Error: ${result.message}`);
            }
          } catch (error) {
            alert(`Error: ${error.message}`);
          }
        });

      // Event listener untuk filter status
      document
        .getElementById("statusFilter")
        .addEventListener("change", function () {
          loadOrders();
        });

      // ===== PROFIL ADMIN SECTION =====
      document.getElementById("sidebarProfile").addEventListener("click", () => {
        showProfileSection();
      });

      function showProfileSection() {
        const mainContent = document.getElementById("mainContent");
        mainContent.innerHTML = `
          <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Profil Admin</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <!-- Info Profil -->
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Informasi Profil</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Lengkap</label>
                    <input type="text" id="adminNamaLengkap" class="w-full border rounded px-3 py-2" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="adminEmail" class="w-full border rounded px-3 py-2" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="adminUsername" class="w-full border rounded px-3 py-2" readonly>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nomor HP</label>
                    <input type="text" id="adminNomorHP" class="w-full border rounded px-3 py-2" readonly>
                  </div>
                </div>
              </div>

              <!-- Upload Foto Profil -->
              <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Foto Profil</h3>
                <div class="space-y-4">
                  <div class="flex items-center space-x-4">
                    <img id="adminFotoPreview" src="/img/default-avatar.png" alt="Foto Profil" 
                         class="w-24 h-24 rounded-full object-cover border-2 border-gray-200">
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-2">Upload Foto Baru</label>
                      <input type="file" id="adminFotoFile" accept="image/*" 
                             class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    </div>
                  </div>
                  <button id="uploadFotoBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition duration-200">
                    Upload Foto
                  </button>
                  <p class="text-xs text-gray-500">Format: JPG, PNG, GIF, WebP. Maksimal 5MB.</p>
                </div>
              </div>
            </div>
          </div>
        `;

        // Load admin profile data
        loadAdminProfile();
        
        // Add event listener for photo upload
        document.getElementById("uploadFotoBtn").addEventListener("click", uploadAdminPhoto);
      }

      async function loadAdminProfile() {
        try {
          const adminToken = localStorage.getItem("adminToken");
          const response = await fetch("/api/admin/profile", {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${adminToken}`,
            },
          });

          if (response.ok) {
            const adminData = await response.json();
            
            // Fill form fields
            document.getElementById("adminNamaLengkap").value = adminData.namaLengkap || "";
            document.getElementById("adminEmail").value = adminData.email || "";
            document.getElementById("adminUsername").value = adminData.username || "";
            document.getElementById("adminNomorHP").value = adminData.nomorHP || "";
            
            // Set profile photo
            const fotoPreview = document.getElementById("adminFotoPreview");
            if (adminData.fotoProfil) {
              fotoPreview.src = adminData.fotoProfil;
            } else {
              fotoPreview.src = "/img/default-avatar.png";
            }
          } else {
            console.error("Failed to load admin profile");
          }
        } catch (error) {
          console.error("Error loading admin profile:", error);
        }
      }

      async function uploadAdminPhoto() {
        const fileInput = document.getElementById("adminFotoFile");
        const adminToken = localStorage.getItem("adminToken");

        if (!fileInput.files || !fileInput.files[0]) {
          alert("Pilih file foto terlebih dahulu!");
          return;
        }

        const formData = new FormData();
        formData.append("photo", fileInput.files[0]);

        try {
          const response = await fetch("/api/admin/uploadPhoto", {
            method: "POST",
            headers: {
              Authorization: `Bearer ${adminToken}`,
            },
            body: formData,
          });

          const result = await response.json();

          if (response.ok) {
            alert("Foto profil berhasil diupload!");
            
            // Update preview
            const fotoPreview = document.getElementById("adminFotoPreview");
            if (result.user && result.user.fotoProfil) {
              fotoPreview.src = result.user.fotoProfil;
            }
            
            // Clear file input
            fileInput.value = "";
          } else {
            alert("Gagal upload foto: " + (result.message || "Unknown error"));
          }
        } catch (error) {
          alert("Error: " + error.message);
        }
      }
    </script>
  </body>
</html>
